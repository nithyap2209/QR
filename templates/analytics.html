{% extends "base.html" %}

{% block title %}Analytics for {{ qr_code.name }} | QR Craft{% endblock %}

{% block head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
{% endblock %}

{% block content %}
<!-- Hero Section with QR Pattern Background -->
<div class="relative overflow-hidden">
    <div class="qr-pattern h-40 relative">
        <div class="absolute inset-0 bg-gradient-to-r from-primary-500/10 to-secondary-600/10"></div>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex items-center">
            <div class="animate-fade-in">
                <a href="{{ url_for('view_qr', qr_id=qr_code.unique_id) }}" class="inline-flex items-center text-sm font-medium text-secondary-600 hover:text-secondary-800 mb-2 transition-colors duration-200">
                    <i class="fas fa-arrow-left mr-2"></i> Back to QR Code
                </a>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Analytics for "{{ qr_code.name }}"</h1>
                <p class="text-gray-600 mt-2">Track performance and engagement metrics for your QR code</p>
            </div>
        </div>
        <!-- Animated QR element in corner -->
        <div class="absolute top-4 right-4 w-16 h-16 animate-qr animate-float"></div>
    </div>
</div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-8 relative z-10 mb-12">
    <!-- Stats Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 animate-fade-in">
        <div class="glass backdrop-blur-lg bg-white/90 rounded-2xl shadow-xl p-6 border border-white/20">
            <div class="flex items-center">
                <div class="h-16 w-16 bg-gradient-to-br from-primary-500 to-primary-600 rounded-2xl flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-qrcode text-2xl"></i>
                </div>
                <div class="ml-6">
                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total Scans</p>
                    <p class="text-3xl font-bold text-gray-900">{{ total_scans }}</p>
                </div>
            </div>
        </div>
        
        <div class="glass backdrop-blur-lg bg-white/90 rounded-2xl shadow-xl p-6 border border-white/20">
            <div class="flex items-center">
                <div class="h-16 w-16 bg-gradient-to-br from-secondary-500 to-secondary-600 rounded-2xl flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-calendar-alt text-2xl"></i>
                </div>
                <div class="ml-6">
                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Created On</p>
                    <p class="text-xl font-bold text-gray-900">{{ qr_code.created_at.strftime('%b %d, %Y') }}</p>
                </div>
            </div>
        </div>
    </div>

    {% if not has_data %}
    <!-- No data state -->
    <div class="glass backdrop-blur-lg bg-white/90 rounded-2xl shadow-xl p-12 text-center animate-fade-in border border-white/20">
        <div class="mx-auto h-24 w-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mb-6 shadow-inner">
            <i class="fas fa-chart-line text-4xl text-gray-400"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-3">No scan data yet</h2>
        <p class="text-gray-600 mb-8 max-w-md mx-auto">Your QR code hasn't been scanned yet. Check back later for analytics insights.</p>
        <a href="{{ url_for('download_qr', qr_id=qr_code.unique_id) }}" 
           class="gradient-bg text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 hover:shadow-glow inline-flex items-center gap-2">
            <i class="fas fa-download"></i>
            Download QR Code
        </a>
    </div>
    {% else %}

    <!-- Main dashboard grid -->
    <div class="space-y-8">
        <!-- Timeline Chart -->
        <div class="glass backdrop-blur-lg bg-white/90 rounded-2xl shadow-xl p-8 border border-white/20 animate-fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                <div class="h-10 w-10 bg-gradient-to-br from-secondary-500 to-secondary-600 rounded-xl flex items-center justify-center text-white">
                    <i class="fas fa-chart-line"></i>
                </div>
                Scan Timeline
            </h2>
            <div class="h-80">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Device Distribution Chart -->
            <div class="glass backdrop-blur-lg bg-white/90 rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in">
                <h2 class="text-lg font-bold text-gray-800 mb-6 flex items-center gap-3">
                    <div class="h-8 w-8 bg-gradient-to-br from-primary-500 to-primary-600 rounded-lg flex items-center justify-center text-white">
                        <i class="fas fa-mobile-alt text-sm"></i>
                    </div>
                    Device Distribution
                </h2>
                <div class="h-64">
                    <canvas id="deviceChart"></canvas>
                </div>
            </div>

            <!-- OS Distribution Chart -->
            <div class="glass backdrop-blur-lg bg-white/90 rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in">
                <h2 class="text-lg font-bold text-gray-800 mb-6 flex items-center gap-3">
                    <div class="h-8 w-8 bg-gradient-to-br from-secondary-500 to-secondary-600 rounded-lg flex items-center justify-center text-white">
                        <i class="fas fa-laptop text-sm"></i>
                    </div>
                    Operating System
                </h2>
                <div class="h-64">
                    <canvas id="osChart"></canvas>
                </div>
                <div class="text-xs text-gray-500 text-center mt-3 italic">
                    *OS data detected from user agent
                </div>
            </div>

            <!-- Hourly Activity -->
            <div class="glass backdrop-blur-lg bg-white/90 rounded-2xl shadow-xl p-6 border border-white/20 animate-fade-in">
                <h2 class="text-lg font-bold text-gray-800 mb-6 flex items-center gap-3">
                    <div class="h-8 w-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center text-white">
                        <i class="fas fa-clock text-sm"></i>
                    </div>
                    Hourly Activity
                </h2>
                <div class="h-64">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Scans Table with Pagination -->
        <div class="glass backdrop-blur-lg bg-white/90 rounded-2xl shadow-xl overflow-hidden border border-white/20 animate-fade-in">
            <div class="px-8 py-6 border-b border-gray-200/50 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-3">
                    <div class="h-10 w-10 bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl flex items-center justify-center text-white">
                        <i class="fas fa-history"></i>
                    </div>
                    Recent Scan Activity
                </h2>
                <div class="glass rounded-full px-4 py-2 text-sm text-gray-600 bg-white/50">
                    Showing {{ (page_num - 1) * 10 + 1 if total_scans > 0 else 0 }}-{{ (page_num * 10) if (page_num * 10 < total_scans) else total_scans }} of {{ total_scans }} scans
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200/30">
                    <thead class="glass bg-gray-50/50">
                        <tr>
                            <th scope="col" class="px-8 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                Date & Time
                            </th>
                            <th scope="col" class="px-8 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                Device & OS
                            </th>
                            <th scope="col" class="px-8 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                Location
                            </th>
                            <th scope="col" class="px-8 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                IP Address
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white/30 divide-y divide-gray-200/30">
                        {% for scan in paginated_scans %}
                        <tr class="hover:bg-white/50 transition-all duration-200">
                            <td class="px-8 py-6 whitespace-nowrap">
                                <div class="text-sm font-bold text-gray-900">{{ scan.timestamp.strftime('%b %d, %Y') }}</div>
                                <div class="text-sm text-gray-600">{{ scan.timestamp.strftime('%I:%M %p') }}</div>
                            </td>
                            <td class="px-8 py-6 whitespace-nowrap">
                                <div class="flex items-center gap-3">
                                    <div class="h-10 w-10 rounded-xl glass bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center shadow-sm">
                                        {% if scan.user_agent and 'Mobile' in scan.user_agent and 'Tablet' not in scan.user_agent %}
                                        <i class="fas fa-mobile-alt text-gray-600"></i>
                                        {% elif scan.user_agent and 'Tablet' in scan.user_agent %}
                                        <i class="fas fa-tablet-alt text-gray-600"></i>
                                        {% else %}
                                        <i class="fas fa-desktop text-gray-600"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        {% if scan.user_agent and 'Mobile' in scan.user_agent and 'Tablet' not in scan.user_agent %}
                                        <div class="text-sm font-bold text-gray-900">Mobile</div>
                                        {% elif scan.user_agent and 'Tablet' in scan.user_agent %}
                                        <div class="text-sm font-bold text-gray-900">Tablet</div>
                                        {% else %}
                                        <div class="text-sm font-bold text-gray-900">Desktop</div>
                                        {% endif %}
                                        <div class="text-xs text-gray-600">
                                            {% if scan.user_agent %}
                                                {% if 'Windows' in scan.user_agent %}Windows
                                                {% elif 'Android' in scan.user_agent %}Android
                                                {% elif 'iPhone' in scan.user_agent or 'iPad' in scan.user_agent or 'iOS' in scan.user_agent %}iOS
                                                {% elif 'Mac OS' in scan.user_agent %}macOS
                                                {% elif 'Linux' in scan.user_agent %}Linux
                                                {% else %}Unknown
                                                {% endif %}
                                            {% else %}Unknown
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-8 py-6 whitespace-nowrap">
                                <span class="glass rounded-full px-3 py-1.5 text-xs font-medium {% if scan.location and scan.location != 'Unknown' %}bg-green-100/80 text-green-800 border border-green-200/50{% else %}bg-gray-100/80 text-gray-800 border border-gray-200/50{% endif %} backdrop-blur-sm">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    {{ scan.location or 'Unknown' }}
                                </span>
                            </td>
                            <td class="px-8 py-6 whitespace-nowrap text-sm text-gray-600 font-mono">
                                {{ scan.ip_address or 'Unknown' }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <!-- Pagination Controls -->
                {% if total_pages > 1 %}
                <div class="glass bg-gray-50/50 px-8 py-4 flex items-center justify-between border-t border-gray-200/30 backdrop-blur-sm">
                    <div class="flex-1 flex justify-between sm:hidden">
                        {% if page_num > 1 %}
                        <a href="{{ url_for('qr_analytics', qr_id=qr_code.unique_id, page=page_num-1) }}" 
                           class="glass backdrop-blur-md bg-white/70 hover:bg-white/90 border border-gray-300/50 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-300 hover:shadow-md">
                            Previous
                        </a>
                        {% else %}
                        <span class="glass backdrop-blur-md bg-gray-100/50 border border-gray-300/50 text-gray-400 font-medium py-2 px-4 rounded-lg cursor-not-allowed">
                            Previous
                        </span>
                        {% endif %}
                        
                        {% if page_num < total_pages %}
                        <a href="{{ url_for('qr_analytics', qr_id=qr_code.unique_id, page=page_num+1) }}" 
                           class="glass backdrop-blur-md bg-white/70 hover:bg-white/90 border border-gray-300/50 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-300 hover:shadow-md">
                            Next
                        </a>
                        {% else %}
                        <span class="glass backdrop-blur-md bg-gray-100/50 border border-gray-300/50 text-gray-400 font-medium py-2 px-4 rounded-lg cursor-not-allowed">
                            Next
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700 font-medium">
                                Showing <span class="font-bold text-primary-600">{{ (page_num - 1) * 10 + 1 if total_scans > 0 else 0 }}</span> to <span class="font-bold text-primary-600">{{ (page_num * 10) if (page_num * 10 < total_scans) else total_scans }}</span> of <span class="font-bold text-primary-600">{{ total_scans }}</span> results
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-xl shadow-sm -space-x-px" aria-label="Pagination">
                                <!-- Previous Page Button -->
                                {% if page_num > 1 %}
                                <a href="{{ url_for('qr_analytics', qr_id=qr_code.unique_id, page=page_num-1) }}" 
                                   class="glass backdrop-blur-md bg-white/70 hover:bg-white/90 border border-gray-300/50 text-gray-500 hover:text-gray-700 font-medium py-2 px-3 rounded-l-xl transition-all duration-300">
                                    <span class="sr-only">Previous</span>
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                                {% else %}
                                <span class="glass backdrop-blur-md bg-gray-100/50 border border-gray-300/50 text-gray-300 font-medium py-2 px-3 rounded-l-xl cursor-not-allowed">
                                    <span class="sr-only">Previous</span>
                                    <i class="fas fa-chevron-left"></i>
                                </span>
                                {% endif %}
                                
                                <!-- Page Number Buttons -->
                                {% set start_page = [1, page_num - 2]|max %}
                                {% set end_page = [start_page + 4, total_pages]|min %}
                                {% if end_page - start_page < 4 and total_pages > 4 %}
                                    {% set start_page = [end_page - 4, 1]|max %}
                                {% endif %}
                                
                                {% for p in range(start_page, end_page + 1) %}
                                    {% if p == page_num %}
                                    <span class="gradient-bg text-white font-bold py-2 px-4 border border-primary-500 shadow-glow">
                                        {{ p }}
                                    </span>
                                    {% else %}
                                    <a href="{{ url_for('qr_analytics', qr_id=qr_code.unique_id, page=p) }}" 
                                       class="glass backdrop-blur-md bg-white/70 hover:bg-white/90 border border-gray-300/50 text-gray-700 hover:text-gray-900 font-medium py-2 px-4 transition-all duration-300">
                                        {{ p }}
                                    </a>
                                    {% endif %}
                                {% endfor %}
                                
                                <!-- Next Page Button -->
                                {% if page_num < total_pages %}
                                <a href="{{ url_for('qr_analytics', qr_id=qr_code.unique_id, page=page_num+1) }}" 
                                   class="glass backdrop-blur-md bg-white/70 hover:bg-white/90 border border-gray-300/50 text-gray-500 hover:text-gray-700 font-medium py-2 px-3 rounded-r-xl transition-all duration-300">
                                    <span class="sr-only">Next</span>
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                                {% else %}
                                <span class="glass backdrop-blur-md bg-gray-100/50 border border-gray-300/50 text-gray-300 font-medium py-2 px-3 rounded-r-xl cursor-not-allowed">
                                    <span class="sr-only">Next</span>
                                    <i class="fas fa-chevron-right"></i>
                                </span>
                                {% endif %}
                            </nav>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Pass data from Flask to JavaScript
    window.hasAnalyticsData = {{ has_data|tojson }};
    {% if has_data %}
        window.scanDatesData = {{ scan_dates|tojson }};
        window.deviceData = {{ device_data|tojson }};
        window.hourlyData = {{ hourly_data|tojson }};
        window.locationData = {{ location_data|tojson }};
        
        // Convert OS data from dict to array format for charts
        window.osData = [];
        {% for os_name, count in os_data.items() %}
            window.osData.push({os: "{{ os_name }}", scans: {{ count }}});
        {% endfor %}
    {% endif %}
    
    // Helper function for RGBA conversion
    function hexToRGBA(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        if (!window.hasAnalyticsData) {
            return;
        }
        
        try {
            // Set Chart.js defaults
            Chart.defaults.font.family = 'Inter, sans-serif';
            Chart.defaults.color = '#64748b';
            
            // Define common colors matching the gradient theme
            const primaryColor = '#8b5cf6';
            const secondaryColor = '#0ea5e9';
            const tertiaryColor = '#f97316';
            const quaternaryColor = '#10b981';
            const accentColor = '#f59e0b';
            const grayColor = '#cbd5e1';
            
            // Timeline Chart
            if (document.getElementById('timelineChart')) {
                const timelineDates = Object.keys(window.scanDatesData);
                const timelineCounts = Object.values(window.scanDatesData);
                
                // Sort dates chronologically
                const dateIndices = timelineDates.map((date, i) => i);
                dateIndices.sort((a, b) => new Date(timelineDates[a]) - new Date(timelineDates[b]));
                
                const sortedDates = dateIndices.map(i => timelineDates[i]);
                const sortedCounts = dateIndices.map(i => timelineCounts[i]);
                
                const timelineCtx = document.getElementById('timelineChart').getContext('2d');
                const timelineChart = new Chart(timelineCtx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'Scans',
                            data: sortedCounts,
                            fill: true,
                            backgroundColor: `linear-gradient(135deg, ${hexToRGBA(primaryColor, 0.3)}, ${hexToRGBA(secondaryColor, 0.1)})`,
                            borderColor: primaryColor,
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 6,
                            pointBackgroundColor: primaryColor,
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 8,
                            pointHoverBackgroundColor: secondaryColor,
                            pointHoverBorderColor: '#ffffff',
                            pointHoverBorderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    parser: 'yyyy-MM-dd',
                                    tooltipFormat: 'MMM d, yyyy',
                                    unit: 'day'
                                },
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#6b7280',
                                    font: {
                                        weight: 500
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    color: '#6b7280',
                                    font: {
                                        weight: 500
                                    }
                                },
                                grid: {
                                    color: '#e5e7eb',
                                    borderDash: [5, 5]
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                padding: 16,
                                cornerRadius: 12,
                                titleColor: '#f8fafc',
                                bodyColor: '#f8fafc',
                                borderColor: primaryColor,
                                borderWidth: 1,
                                displayColors: false,
                                titleFont: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 13,
                                    weight: 500
                                }
                            }
                        }
                    }
                });
            }
            
            // Device Chart
            if (document.getElementById('deviceChart')) {
                const deviceLabels = window.deviceData.map(item => item.device);
                const deviceCounts = window.deviceData.map(item => item.scans);
                const deviceColors = [primaryColor, secondaryColor, tertiaryColor, accentColor, quaternaryColor, grayColor];
                
                const deviceCtx = document.getElementById('deviceChart').getContext('2d');
                const deviceChart = new Chart(deviceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: deviceLabels,
                        datasets: [{
                            data: deviceCounts,
                            backgroundColor: deviceColors.slice(0, deviceLabels.length),
                            borderWidth: 0,
                            hoverBorderWidth: 3,
                            hoverBorderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    font: {
                                        weight: 600,
                                        size: 12
                                    },
                                    color: '#374151'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                padding: 16,
                                cornerRadius: 12,
                                titleColor: '#f8fafc',
                                bodyColor: '#f8fafc',
                                borderColor: primaryColor,
                                borderWidth: 1,
                                displayColors: true,
                                titleFont: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 13,
                                    weight: 500
                                },
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round(value / total * 100);
                                        return `${label}: ${value} scans (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // OS Chart
            if (document.getElementById('osChart')) {
                const osLabels = window.osData.map(item => item.os);
                const osCounts = window.osData.map(item => item.scans);
                const osColors = [primaryColor, secondaryColor, quaternaryColor, tertiaryColor, accentColor, '#0f766e', grayColor];
                
                const osCtx = document.getElementById('osChart').getContext('2d');
                const osChart = new Chart(osCtx, {
                    type: 'doughnut',
                    data: {
                        labels: osLabels,
                        datasets: [{
                            data: osCounts,
                            backgroundColor: osColors.slice(0, osLabels.length),
                            borderWidth: 0,
                            hoverBorderWidth: 3,
                            hoverBorderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    font: {
                                        weight: 600,
                                        size: 12
                                    },
                                    color: '#374151'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                padding: 16,
                                cornerRadius: 12,
                                titleColor: '#f8fafc',
                                bodyColor: '#f8fafc',
                                borderColor: primaryColor,
                                borderWidth: 1,
                                displayColors: true,
                                titleFont: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 13,
                                    weight: 500
                                },
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round(value / total * 100);
                                        return `${label}: ${value} scans (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Hourly Chart
            if (document.getElementById('hourlyChart')) {
                const hourLabels = Array.from({length: 24}, (_, i) => {
                    const hour = i % 12 || 12;
                    const ampm = i < 12 ? 'AM' : 'PM';
                    return `${hour}${ampm}`;
                });
                
                const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
                const hourlyChart = new Chart(hourlyCtx, {
                    type: 'bar',
                    data: {
                        labels: hourLabels,
                        datasets: [{
                            label: 'Scans',
                            data: window.hourlyData,
                            backgroundColor: secondaryColor,
                            borderRadius: 8,
                            borderSkipped: false,
                            barPercentage: 0.7,
                            categoryPercentage: 0.8,
                            hoverBackgroundColor: quaternaryColor
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    color: '#6b7280',
                                    font: {
                                        weight: 500,
                                        size: 11
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    color: '#6b7280',
                                    font: {
                                        weight: 500
                                    }
                                },
                                grid: {
                                    color: '#e5e7eb',
                                    borderDash: [5, 5]
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                padding: 16,
                                cornerRadius: 12,
                                titleColor: '#f8fafc',
                                bodyColor: '#f8fafc',
                                borderColor: secondaryColor,
                                borderWidth: 1,
                                displayColors: false,
                                titleFont: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 13,
                                    weight: 500
                                }
                            }
                        }
                    }
                });
            }
            
            // Location Chart
            if (document.getElementById('locationChart') && window.locationData && window.locationData.length > 0) {
                const locationLabels = window.locationData.map(item => item.location);
                const locationCounts = window.locationData.map(item => item.scans);
                
                const locationCtx = document.getElementById('locationChart').getContext('2d');
                const locationChart = new Chart(locationCtx, {
                    type: 'bar',
                    data: {
                        labels: locationLabels,
                        datasets: [{
                            label: 'Scans',
                            data: locationCounts,
                            backgroundColor: primaryColor,
                            borderRadius: 8,
                            borderSkipped: false,
                            hoverBackgroundColor: secondaryColor
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    color: '#6b7280',
                                    font: {
                                        weight: 500
                                    }
                                },
                                grid: {
                                    color: '#e5e7eb',
                                    borderDash: [5, 5]
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#6b7280',
                                    font: {
                                        weight: 500
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                padding: 16,
                                cornerRadius: 12,
                                titleColor: '#f8fafc',
                                bodyColor: '#f8fafc',
                                borderColor: primaryColor,
                                borderWidth: 1,
                                displayColors: false,
                                titleFont: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 13,
                                    weight: 500
                                }
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error("Error initializing charts:", error);
            
            // Create error message elements for failed charts
            const chartContainers = document.querySelectorAll('#timelineChart, #deviceChart, #osChart, #hourlyChart, #locationChart');
            chartContainers.forEach(container => {
                if (container) {
                    const parent = container.parentElement;
                    parent.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center p-8">
                                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-red-100 to-red-200 rounded-full mb-4">
                                    <i class="fas fa-exclamation-circle text-2xl text-red-500"></i>
                                </div>
                                <p class="text-gray-600 font-medium">Could not load chart data</p>
                                <p class="text-gray-500 text-sm mt-1">Please refresh the page to try again</p>
                            </div>
                        </div>
                    `;
                }
            });
        }
    });
</script>
{% endblock %}